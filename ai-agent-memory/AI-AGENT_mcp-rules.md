# AI-AGENT_mcp-rules.md

## 目标
- 为项目级 AI-AGENT 提供统一的 MCP 服务使用规范，确保选择得当、调用可追溯、风险可控。
- 指导代理在多 MCP 场景下分辨职责边界，避免重复调用或造成资源浪费。
- 保证所有外部服务调用均有日志、参数与结论记录，便于复盘与审计。

## 全局策略
- **工具选择**：以任务意图为先，避免同类服务并行调用；若存在原生能力可满足需求，优先使用本地/离线方案。
- **最小必要**：仅在确认输入、范围、速率后再调度 MCP；限定查询参数（结果数、时间窗、关键词等）。
- **结果可靠性**：输出需包含来源、时间戳与不确定性说明；可复核的要点优先。
- **可追溯性**：除为日志记录本身必需的`mcp-time`与写入操作外，每次调用完成后必须立刻写入 `ai-agent-output/YYYY-MM-DDTHH-MM-SS_UTC_任务简述/mcp-log.csv`。记录流程为：①调用`mcp-time`获取时间戳 → ②执行目标MCP → ③按字段顺序追加至CSV（时间戳、服务、调用类型、参数摘要、输出摘要、备注），并在备注中注明特殊情况或失败重试。
- **临时约定**：若用户在 `general/user-temp-opinion.md` 中声明忽略特定MCP的记录，应在执行与备注中引用该文档作为豁免依据。
- **说明文档**：`mcp-log.md`保留为结构说明和补充说明文件，所有结构化数据以CSV为准。
- **安全合规**：遵守目标服务的 ToS/隐私条款；严禁上传敏感数据；默认使用只读权限，若需写操作必须显式说明。
- **降级优先**：外部服务不可用时，应提供明确的降级方案或本地替代结论并标注风险。

## 安全与权限边界
- 严格遵守目录与网络白名单；如需扩展访问范围，须先更新根目录或凭证并记录原因。
- 涉及写操作或命令执行的服务必须评估对当前仓库/环境的影响，执行前向用户说明潜在副作用。

## 失败与降级流程
1. 判断失败原因（网络、权限、任务理解等）。
2. 如有备选服务，按优先级降级重试；无可替代方案时给出保守答案并记录阻塞因素。
3. 在 `ai-agent-output/YYYY-MM-DDTHH-MM-SS_UTC_任务简述/mcp-log.csv` 中补充失败说明、重试情况与后续计划，必要时引用临时意见文档说明豁免条目。

## 服务指引概览
| 服务 | 包名/入口 | 主要用途 | 写操作风险 |
| --- | --- | --- | --- |
| Sequential Thinking | 内置 `mcp-sequential-thinking` | 复杂任务规划、步骤生成 | 无 |
| web-search | 内置 `mcp-web-search` | 最新网页/资讯检索 | 无 |
| Context7 | 内置 `mcp-context7` | 官方文档/SDK 检索 | 无 |
| Serena | 内置 `mcp-serena` | 代码语义检索与符号级编辑 | 高，需要谨慎写操作 |
| Filesystem | 内置 `mcp-filesystem` | 受控文件读写、目录管理 | 高，需要限定根目录 |
| Playwright | 内置 `mcp-playwright` | 浏览器自动化、可访问性操作 | 中，涉及网页交互 |
| DeepWiki | 内置 `mcp-deepwiki` | 仓库文档检索与问答 | 低，仅网络访问 |
| Desktop Commander | 内置 `mcp-desktop-commander` | 本地终端+文件系统增强 | 高，支持命令执行 |

## 服务详情

### 1. Sequential Thinking（规划分解）
- **适用场景**：需求复杂、包含多模块或存在多方案竞选时，用于构建结构化执行计划与里程碑。
- **调用建议**：限制单次输出步数 ≤12；若计划仍过长，可分多轮对不同模块分别调用。
- **使用要点**：
  - 输入中描述背景、目标、约束与已知成果，提升计划针对性。
  - 生成的步骤需在进入执行前再次评审，与 TodoWrite 或状态表保持同步。
  - 对需人工确认的分支，建议在输出中标注“待确认”。
- **失败与降级**：结果抽象或偏离目标时，补充上下文后重试；若仍效果有限，回到人工拆解并在文档中说明原因。

### 2. web-search（网络检索）
- **适用场景**：获取最新网页信息、官方公告、下载链接或权威报道。
- **查询规范**：
  - 使用≤12个精准关键词，可搭配 `site:`、`filetype:`、`after:YYYY-MM` 等限定词。
  - 结果上限建议≤35，优先官方域名或权威媒体，剔除内容农场与短链重定向。
- **输出要求**：每条结果需包含标题、简述、URL、抓取时间，必要时附二次验证提示。
- **风险控制**：
  - 网络受限或未授权时不调用，改用本地资料并说明局限。
  - 失败时至多重试一次，仍无结果则给出降级方案。
  - 遵守目标站点 robots 与 ToS，不上传敏感信息。

### 3. Context7（技术文档聚合）
- **适用场景**：检索 SDK/API 官方文档、快速比对参数与版本差异、获取示例代码。
- **调用流程**：
  1. 使用 `resolve-library-id` 获取准确库 ID（示例：`/vercel/next.js/v14.3.0`）。
  2. 通过 `get-library-docs` 指定 `topic`/`tokens` 聚焦输出范围。
  3. 在答案中注明库 ID、版本与引用段落，保持可追溯。
- **使用策略**：
  - 同一会话内避免重复请求大段文档，按主题分批获取。
  - resolve 失败时应请求用户澄清库名称或版本。
- **降级方案**：转向 web-search（优先官方站点）或本地经验，并明确标注不确定性。

### 4. Serena（代码语义检索与编辑）
- **适用场景**：需要按符号定位代码、查看引用、执行结构化插入/替换或批量重构。
- **操作流程**：
  1. 激活项目并确认索引完成。
  2. 使用 `find_symbol`、`find_referencing_symbols`、`search_for_pattern` 精准定位目标位置。
  3. 通过 `insert_before_symbol`、`insert_after_symbol`、`replace_symbol_body` 等工具执行修改。
- **使用策略**：
  - 优先小范围、原子化操作；大范围改动前先设计方案。
  - 写操作前执行 dry-run 或生成 diff，必要时回滚。
  - 重要修改需同步更新状态与提交计划。
- **风险控制**：涉及写操作必须说明影响范围并准备回滚；禁止操作未授权目录或临时文件。

### 5. Filesystem（本地文件系统）
- **适用场景**：读取/写入仓库文件、查询目录结构、执行小范围文本替换。
- **启动建议**：使用 `npx @modelcontextprotocol/server-filesystem <allowed_dir>`；若客户端支持 Roots 协议，优先通过 Roots 动态下发访问目录。
- **使用要点**：
  - 操作前确认目标路径位于允许目录内，必要时更新 Roots 并记入日志。
  - 大文件编辑优先使用 `edit_file` + `dryRun` 预览差异，再执行正式修改。
  - `write_file` 为全量覆盖，适用于初始化或模板写入，需谨慎。
  - 使用 `list_allowed_directories` 与 `get_file_info` 核对权限及元数据。
- **风险防范**：禁止跨越白名单目录；若需创建/移动文件，应记录触发原因与回滚手段。
- **常用工具速览**：`read_text_file`、`read_media_file`、`edit_file`、`create_directory`、`list_directory_with_sizes`。

### 6. Playwright（浏览器自动化）
- **适用场景**：需要真实浏览器环境完成交互、获取动态内容、验证前端流程。
- **启动建议**：`npx @playwright/mcp@latest`；首次运行若提示未安装浏览器，调用 `browser_install`。
- **能力亮点**：
  - 通过可访问性树操作元素，避免截图识别；`browser_snapshot` 可获取结构上下文。
  - 提供点击、拖拽、表单填写、截图、PDF 输出、标签页管理、追踪记录等工具。
  - 可通过 `--caps=vision|pdf|verify|tracing` 启用额外功能，仅在确有需要时打开。
- **操作规范**：
  - 发送指令前描述目标元素（`element` 字段）与预期行为，确保权限请求准确。
  - 对外部网站遵守 robots 与速率限制，避免自动化滥用；必要时交替人工确认。
  - 动态页面建议先使用 `browser_wait_for` 等等待工具确保状态稳定。
- **输出要求**：保存关键截图或 PDF 结果，并在 `ai-agent-output/YYYY-MM-DDTHH-MM-SS_UTC_任务简述/mcp-log.csv` 标注 URL、步骤与耗时（必要时可在`mcp-log.md`补充说明）。

### 7. DeepWiki（仓库知识检索）
- **适用场景**：快速了解公共或授权仓库的结构、文档与实现要点，辅助代码审阅或调研。
- **配置方式**：
  - 公共仓库使用 `"url": "https://mcp.deepwiki.com/sse"`；
  - 私有仓库改用 `https://mcp.devin.ai/sse` 并在 `headers` 中携带 `Authorization: Bearer <API_KEY>`；
  - 需要 Streamable HTTP 时可调用 `https://mcp.deepwiki.com/mcp`。
- **核心工具**：
  - `read_wiki_structure`：获取目录与主题列表，用于定位关注模块。
  - `read_wiki_contents`：读取指定页面的文档内容。
  - `ask_question`：针对仓库提出自然语言问题，返回上下文答案与引用。
- **使用要点**：
  - 首次查询前确认仓库是否已被 DeepWiki 收录；若未收录，需回退到本地阅读或其他文档源。
  - 问答结果用于参考，不可直接视为事实；必要时再结合源码验证。
- **记录要求**：在日志中注明仓库地址、工具、关键结论与未解决问题。

### 8. Desktop Commander（终端与文件系统增强）
- **适用场景**：需要在本机执行终端命令、长任务或复杂文件操作，并获取实时输出。
- **安装建议**：`npx @wonderwhy-er/desktop-commander@latest setup`（支持自动更新）；可通过 `--debug` 开启调试模式，`remove` 命令卸载。
- **能力范围**：
  - 终端执行：支持输出流式返回、后台运行、超时设置。
  - 进程/会话管理：`list_processes`、`kill_process`、`list_sessions`、`interact_with_process` 等。
  - 文件与搜索：继承 filesystem 能力，同时提供 ripgrep 搜索与批量替换。
  - 数据分析：可直接请求运行 Python/Node/R 脚本，对本地 CSV/JSON 做即时分析。
  - 配置/反馈：`get_usage_stats`、`give_feedback_to_desktop_commander` 等辅助工具。
- **安全控制**：
  - 默认具有写权限与命令执行能力，务必在日志中描述命令目标、预期与风险。
  - 若需访问仓库外目录，应先得到授权并更新允许目录/环境变量。
- **风险提示**：运行可能改变系统状态的脚本时需提供回滚方案或额外确认。

## 记录与复盘要求
- 所有 MCP 调用均需在 `ai-agent-output/YYYY-MM-DDTHH-MM-SS_UTC_任务简述/mcp-log.csv` 留痕，包含：时间戳、服务、调用类型、参数摘要、输出摘要、后续动作/风险，并在备注中说明豁免来源（如引用临时意见文档）。
- 任务结束前，对照本文件逐项核对：是否存在未关闭的远程会话、临时目录或待清理数据。
- 若新增 MCP 服务或调整现有规则，应同步修改本文件并在提交信息中注明“更新 MCP 规范”。
