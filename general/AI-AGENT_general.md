# AI-AGENT_general.md

面向所有通用任务的操作指引。进入任何环节之前，请先阅读此文档并完成与环节相关的检查项。本文件覆盖通用要求、工作环节划分、任务内容优化以及工作状态记录规范。

## 使用说明
- 首先完整阅读项目根目录下的`AI-AGENT.md`，并确认`ai-agent-memory/`目录内的文件已复制到项目中。
- 在首次进入“任务前置准备”环节前，需要创建`AI-AGENT_working-status.csv`，并按“工作状态记录规范”维护工作状态。
- 若在执行过程中需要编程或专业化开发支持，请结合`AI-AGENT_programming.md`中的额外要求一起使用。
- 全程使用简体中文进行思考、记录和对话，保持术语统一。
- 使用 serena 将当前目录激活为项目。
- 调用任何MCP服务前，必须先核对`AI-AGENT_mcp-rules.md`中的适用场景、权限边界与日志要求。

## 工作环节概览
1. **任务前置准备**：通过几个子环节完成任务的确定，每次进入新的子环节时更新工作状态。
   1. 任务分析阶段
   2. 任务内容优化阶段
   3. 待定项处理机制
   4. 优化结果生成

2. **流程设计**：梳理解决方案流程，输出设计方案（必要时绘制流程图或结构图）。
3. **任务主体流程循环**：按流程设计逐步推进任务，每次进入新的子环节时更新工作状态。
4. **验证结果**：核对实际产出是否满足优化任务的成功标准与质量要求。
5. **文档更新**：同步维护项目内需要更新的文档以及关键决策记录。
6. **收尾**：清理临时内容、恢复用户编辑区、总结本轮工作。

## 工作状态记录规范
- 文件：`AI-AGENT_working-status.csv`，首次进入“任务前置准备”前创建。
- 存储位置：在项目初始化时于`ai-agent-output/YYYY-MM-DDTHH-MM-SS_UTC_任务简述/`目录下集中存放`AI-AGENT_working-status.csv`、`undetermined.md`、`optimized-task.md`、`mcp-log.csv`与`mcp-log.md`等辅助文档，任务简述建议控制在8-20字，例如`ai-agent-output/2025-10-11T20-37-40_UTC+8_更新指令存储规范/optimized-task.md`。
- 添加记录时总是**插入在表头后第一行，即文档第二行**，确保最新状态在最上方。
- 每条记录必须包含以下信息：
  - **时间戳**：使用`mcp-time`获取的实时时间，推荐格式：`YYYY-MM-DD HH:MM:SS (时区)`。
  - **短述**：2-10个字，概括状态变化，如“初始状态”“推进”“返工”“暂停”等。
  - **当前环节**：与上文六个环节之一保持一致，若处于任务主体中的子步骤，须补充子步骤名称。
  - **项目状态概况**：10-200字，描述当前成果、待办事项、阻塞点或重要决策。
- 在执行提交前必须先运行`git add .`，确保所有未被`.gitignore`忽略的文件均被纳入版本管理。
- 每次更新`AI-AGENT_working-status.csv`后，应立即创建一次git提交，提交信息概述本次状态更新，以便回溯文档变更。
- 模板示例（复制为首条记录后按需改写）：
  ```
  时间戳,短述,当前环节,项目状态概况
  2025-01-18 14:03:22 (Asia/Shanghai),初始状态,任务前置准备,已审阅全部指令，准备整理now-task.md，尚未生成优化任务文档。
  ```
- 在旧环节结束时立即更新记录，进入新环节前必须对照最新记录确认环节一致；若不一致需暂停并排查原因。

## 1. 任务前置准备
遵循`AI-AGENT_step-before.md`的要求，完成准备工作。

- 在“任务内容优化阶段”中，必须对任务目标进行多维度分析，列出所有可能的优化方案，并按模板写入`undetermined.md`；未经用户统一确认不得进入下一环节。
- 结合`general/user-temp-opinion.md`中的当前任务临时意见，判断是否需要额外的日志豁免或执行约束，并在向用户汇报时一并确认。
- 用户确认后，仅保留采纳方案，其余待定项需删除，并将结论汇总至`optimized-task.md`。
- 每次进入新的子环节时更新工作状态，若临时意见有变更，应立即记录原因与影响。

## 2. 流程设计
- **目标**：将优化后的任务拆解为可执行的流程，明确输入、输出、依赖与风险。
- **设计步骤**：
  1. 梳理任务主线和关键节点，确认执行顺序。
  2. 对存在多种实现方案或不确定点的部分，列出选项并准备向用户确认。
  3. 必要时使用思维导图/流程图（如PlantUML）呈现结构；对于复杂流程，应拆分为模块并标注接口。
  4. 在生成`optimized-task.md`前，再次对照`undetermined.md`与`general/user-temp-opinion.md`，确保临时意见与待定项结论已全部整合。
  5. 更新`optimized-task.md`中的流程描述与验证标准。
- **校验要点**：保持方案满足KISS、YAGNI等原则，避免冗余和不必要复杂度。
- **状态记录**：在切换到“流程设计”时，插入工作状态记录，描述设计进度与风险评估。

## 3. 任务主体流程循环
- **执行原则**：
  - 严格按照已确认的流程执行，每完成一个子环节立即更新`AI-AGENT_working-status.csv`。
  - 对发现的新风险或需求变更立即记录并评估是否需要返工至前序环节。
  - 使用TodoWrite或等效工具跟踪每个主要步骤及对应提交。
- **处理分支情况**：
  - 若执行中出现阻塞或现有设计不可行，应创建状态记录（如“返工”），回到必要的环节重新设计。
  - 所有重要决策、折衷方案需同步记录到相关文档（如`optimized-task.md`或设计说明）。
- **沟通要求**：对于用户需确认的事项，集中整理后再统一询问，避免零散沟通。

## 4. 验证结果
- 按`optimized-task.md`定义的验证标准进行检查，确保所有功能、文档或交付物符合预期。
- 对照`AI-AGENT_check.md`的对应环节检查项，确认测试数据、假设条件、例外情况均已覆盖。
- 若验证失败，记录原因与整改计划，将状态调整回“任务主体流程循环”或更早的环节。
- 更新工作状态记录，注明验证结论与残留问题。

## 5. 文档更新
- 同步更新受影响的文档（如项目`README.md`、`CHANGELOG.md`、流程图、配置说明等）。
- 更新工作状态后，应先维护`CHANGELOG.md`，确认条目完整；完成条目维护后必须立即根据本轮任务创建新的版本号段落（写入日期并重建空的`[Unreleased]`区块），再执行`git add .`与后续提交。
- 正式文档归档于`docs/`目录，对话或评审材料存放于`discuss/`目录，注意保持语言与格式统一。
- 在项目级`AI-AGENT.md`中记录新增约定、规范调整与重要决策；若`general/user-temp-opinion.md`有新的选项或模板调整，应在此阶段同步确认。
- 确保任务执行中的所有临时文件、脚本说明等整理妥当并附带说明。
- 在状态记录中说明已更新的文档及是否仍需用户补充信息。

## 6. 收尾
- 清理临时文件、辅助脚本和不再使用的草稿，确保仓库保持整洁。
- 恢复`now-task.md`为等待用户输入的初始状态（仅保留标题），保留`ai-agent-output/`下的辅助文档目录，无需再删除`optimized-task.md`、`undetermined.md`、`mcp-log.csv`或`mcp-log.md`，并确认本轮版本号已更新记录在`CHANGELOG.md`中。
- 核对提交计划与实际提交是否一致，必要时补充说明或提交。
- 添加最终状态记录，简述交付成果、遗留风险与后续建议。
- 若需要继续后续任务，提醒用户更新`now-task.md`并重新启动流程。
