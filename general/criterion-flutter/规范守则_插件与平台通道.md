# 规范守则 - 插件与平台通道

## 项目类型
- Flutter插件项目、混合栈集成、原生能力桥接（Camera、蓝牙、支付等）。
- 涉及 Android、iOS、Web、桌面等平台代码协作。

## 核心原则
### 1. 项目结构与代码组织
- 使用 `flutter create --template=plugin` 初始化；开启Federated插件模式拆分平台实现。
- 将平台代码置于 `android/src/main/kotlin`、`ios/Classes`、`macos/Classes` 等目录，保持命名空间一致。
- 编写清晰的 Method Channel API 文档，定义请求与响应模型（建议使用 Pigeon 自动生成类型安全代码）。

### 2. 通信与线程安全
- 使用 [Platform Channels](https://docs.flutter.dev/platform-integration/platform-channels) 或 `EventChannel`/`BasicMessageChannel` 处理异步通讯。
- Android 侧保持在主线程更新UI，耗时操作放入 `Executor`；iOS 使用 `dispatch_async`。
- 设计错误码与异常映射，统一抛出 `PlatformException`。

### 3. 版本与兼容性
- 遵循语义化版本，记录支持的Flutter/Dart版本与平台最低版本。
- 编写 CHANGELOG 与 README 示例，提供快速集成指引。
- 使用CI在多个平台运行单元与集成测试；Android通过`gradlew lint`、iOS通过`xcodebuild test`。

## 项目结构建议
```
my_plugin/
├── lib/
│   ├── my_plugin.dart           # Dart API 封装
│   └── src/
├── platform_interface/
├── android/src/main/kotlin/...  # MethodChannel实现
├── ios/Classes/
├── macos/Classes/
├── example/
│   └── lib/main.dart
└── pigeon/                      # Pigeon schema
```

## 测试与交付
- Dart 层单元测试：通过 `mocktail` 模拟平台响应。
- 平台层测试：Android使用JUnit/Mockito，iOS使用XCTest；Scenario App验证实际设备。
- 通过 `flutter analyze`、`dart format` 保持代码风格，使用 `melos` 管理多包结构。
- 发布前运行 `flutter pub publish --dry-run`，确保pub.dev检查通过。

## 安全与性能
- 谨慎处理原生权限请求与隐私数据；遵守苹果/谷歌后台限制。
- 处理平台回调时防止内存泄漏，Android注意 Activity 生命周期与 Registrant。
- 若性能敏感，使用 FFI 或 Platform View 时遵循官方性能建议。

## 参考资料
- [Flutter Platform Channels](https://docs.flutter.dev/platform-integration/platform-channels)
- [Pigeon: Flutter Tool](https://pub.dev/packages/pigeon)
- [Federated Plugin Design](https://docs.flutter.dev/packages-and-plugins/federated-plugins)
- [Writing Custom Platform-specific Code](https://docs.flutter.dev/platform-integration)
- [Flutter Plugin Example](https://github.com/flutter/plugins)
