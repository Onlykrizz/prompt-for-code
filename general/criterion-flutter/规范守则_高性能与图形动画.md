# 规范守则 - 高性能与图形动画

## 项目类型
- 强交互/动画应用、游戏原型、数据可视化、需要高帧率与低延迟的Flutter项目。

## 核心原则
### 1. 渲染优化
- 避免在`build`中执行重计算，使用 `const` 构造、`ValueListenableBuilder`、`Selector` 等细粒度刷新。
- 将复杂绘制使用 `CustomPainter`，必要时启用 `PictureRecorder`、`ui.Image` 缓存。
- 使用 `RepaintBoundary`、`Clip.none` 减少无必要的重绘。

### 2. 动画与图形
- 充分使用 `ImplicitlyAnimatedWidget` 与 `AnimationController` + `TickerProvider`; 复杂场景使用 `AnimationController.unbounded` 或 `TweenSequence`。
- 对3D/高级效果，可集成 `Rive`、`Flame` 或 `SceneKit`/`ARKit` 插件。
- 优化资产加载：图片使用 `cached_network_image`、`precacheImage`，视频使用 `video_player` + ExoPlayer。

### 3. 多线程与异步
- 将CPU密集任务放入 `compute` 或自定义 `Isolate`；利用 `package:isolate_runner` 简化通信。
- 对平台通道调用进行批量化处理，减少多次MethodChannel开销。

## 性能剖析
- 运行 `flutter run --profile`，通过 `DevTools` 的 Performance、CPU Profiler 识别瓶颈。
- 关注 GPU 线程、Raster thread 的时序；对图像过大问题进行压缩或分辨率调整。
- 在Web端评估 CanvasKit 与 html 渲染器差异，按需选择。

## 项目结构建议
```
high_perf_app/
├── lib/
│   ├── main.dart
│   ├── presentation/
│   │   ├── animations/
│   │   └── painters/
│   └── services/isolate_tasks.dart
├── assets/
│   ├── rive/
│   └── shaders/
└── test/
```

## 测试与度量
- 使用 `integration_test` + `flutter drive --profile` 收集性能日志。
- 集成 `metrics_center` 或自定义帧率采集工具，关注 `jank` 与 `FrameBuildTime`。
- 编写基准测试（`benchmark_harness`）评估关键算法性能。

## 参考资料
- [Flutter Performance Best Practices](https://docs.flutter.dev/perf/best-practices)
- [Flutter Performance Profiling](https://docs.flutter.dev/perf/ui-performance)
- [Flutter DevTools](https://docs.flutter.dev/tools/devtools/performance)
- [Flame Engine Documentation](https://docs.flame-engine.org/)
- [Rive Integration Guide](https://help.rive.app/hc/en-us/articles/360059087473-Using-Rive-in-Flutter)
