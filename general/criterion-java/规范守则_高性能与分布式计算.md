# 规范守则 - 高性能与分布式计算

## 项目类型
- 低延迟交易系统、实时通信网关、分布式计算平台、Reactive API、消息中间件
- 技术栈：Netty、Project Reactor、Vert.x、Akka、gRPC、RSocket、Hazelcast、Infinispan

## 性能调优原则
- 目标指标：P99延迟、吞吐（req/s）、GC暂停时间、CPU与内存利用率。
- JVM选择：JDK 17+ LTS；根据场景选择G1、ZGC、Shenandoah，并结合`-Xms/-Xmx`固定堆大小。
- 监控GC：开启`-Xlog:gc*:file=gc.log:time,uptime,tid`，定期分析停顿与吞吐。
- 线程模型：避免阻塞式调用；使用虚拟线程（JDK 21 Loom）或Reactor调度器减少线程数。

## 并发与资源管理
- 遵循《Java Concurrency in Practice》建议：使用不可变对象、`ConcurrentHashMap`、`Atomic*`类、`CompletableFuture`。
- 线程池：自定义`ThreadFactory`命名线程；根据CPU核心数设置合理的核心/最大线程数；防止无限队列造成OOM。
- 使用 [Disruptor](https://lmax-exchange.github.io/disruptor/) 或 Reactor Sinks 处理极低延迟需求。

## 网络与IO
- Netty架构：
  - 使用事件循环组区分Boss与Worker线程。
  - ChannelHandler按职责拆分，避免耗时操作阻塞EventLoop。
  - 引入背压控制和连接管理（IdleStateHandler、RateLimiter）。
- gRPC/RSocket：启用TLS、Keep-Alive、Compression，并在客户端实现指数退避重试。

## 项目结构示例（Netty + Reactor）
```
perf-service/
├── build.gradle.kts
├── src/main/java/
│   ├── com/example/perf/bootstrap/ServerBootstrapper.java
│   ├── com/example/perf/netty/handler/
│   ├── com/example/perf/domain/
│   └── com/example/perf/reactive/MessageProcessor.java
├── src/main/resources/
│   └── application.yaml
└── src/test/java/
    └── com/example/perf/netty/handler/FrameDecoderTest.java
```

## 测试与验证
- 基准测试：使用 [JMH](https://openjdk.org/projects/code-tools/jmh/) 编写微基准，关注稳定性（热身、迭代次数）。
- 压力测试：`wrk`、`k6`、`Gatling`、`netty-tcnative`；在测试期间记录延迟分布与GC日志。
- 故障演练：Chaos Monkey、ToxiProxy 模拟网络抖动、节点宕机；验证弹性策略。
- 性能回归：结合CI执行JMH或业务基准，设定阈值防止性能下降。

## 运维与SRE
- 指标采集：Micrometer + Prometheus；重点监控线程池使用率、队列长度、GC停顿、耗时TopN。
- 资源隔离：不同工作负载使用独立线程池或Scheduler；谨慎使用全局静态状态。
- 部署建议：Pin CPU（或Cgroup绑定）、NUMA配置、使用JIT编译参数（`-XX:+UseJVMCICompiler`）。
- 灾备：多区域部署 + 全链路压测；对有状态组件（Hazelcast、Cassandra）启用跨Region复制。

## 参考资料
- [Netty User Guide](https://netty.io/wiki/user-guide-for-4.x.html)
- [Maximizing Performance with Netty and Reactive Programming](https://objectcomputing.com/how-we-share/articles/2024/06/27/maximizing-performance-netty-and-reactive-programming-java)
- [Java Performance Tuning Tips (javaperformancetuning.com)](https://www.javaperformancetuning.com/news/newtips289.shtml)
- [Java Performance Optimization & GC Tuning](https://zuniweb.com/blog/java-performance-optimization-jvm-tuning-gc-tuning-and-concurrency-best-practices/)
- [Java Concurrency in Practice – Brian Goetz](https://www.bookey.app/book/java-concurrency-in-practice)
