# 规范守则 - 状态管理与数据同步

## 项目类型
- 含复杂状态、异步数据同步、多数据源整合的 React(TypeScript) 应用。

## 核心原则
### 1. 状态分层
- 区分 Server State 与 Client State：
  - Server State 使用 [TanStack Query](https://tanstack.com/query/v4/docs/framework/react/overview) 处理缓存、重试、失效策略。
  - Client/UI State 使用 Redux Toolkit、Zustand 或 Jotai，根据规模选择。
- 使用 `React.Context` 仅传递跨层配置，不承担业务状态。

### 2. 类型安全
- 为 API 响应定义 `zod` 或 `io-ts` schema，结合 TanStack Query 的 `select` 与 `transform`。
- 在 Redux Toolkit 中使用 `createSlice` + `PayloadAction<Type>` 明确 payload 类型。
- 统一 store 导出类型：`RootState`、`AppDispatch`，配合 `useAppSelector`、`useAppDispatch`。

### 3. 异步与同步策略
- Server State 配置 `staleTime`、`cacheTime`、`retry`、`refetchOnWindowFocus`；Edge场景可使用 `persister` 缓存数据。
- 对 WebSocket/事件流使用 `rxjs` 或 `EventSource` + TanStack Query `queryClient.setQueryData`。
- 对乐观更新执行回滚逻辑，记录失败状态供UX反馈。

## 项目结构示例
```
app/
├── src/
│   ├── app/store.ts
│   ├── services/apiClient.ts
│   ├── features/todos/todoSlice.ts
│   ├── features/todos/hooks.ts
│   └── providers/QueryProvider.tsx
└── ...
```

## 测试与质量
- 单元测试：使用 `@reduxjs/toolkit` 提供的 `configureStore` 搭建测试环境；TanStack Query 使用 `QueryClientProvider` + `hydrate`。
- 集成测试：React Testing Library 模拟用户操作与网络请求。
- 在CI中运行 `pnpm test -- --runInBand` 、`tsc --noEmit`、`eslint`。

## 参考资料
- [TanStack Query Guide](https://tanstack.com/query/v4/docs/framework/react/guides/does-this-replace-client-state)
- [Redux Toolkit Documentation](https://redux-toolkit.js.org/)
- [Comparing TypeScript State Management Solutions](https://blog.logrocket.com/comparing-typescript-state-management-solutions/)
- [Modernizing React Applications with Redux Toolkit & TanStack](https://makepath.com/modernizing-your-react-applications-from-redux-to-zustand-tanstack-query-and-redux-toolkit/)
